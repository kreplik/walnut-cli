# Test multi-contract simulation functionality
# REQUIRES: soldb, sepolia-rpc
# RUN: %soldb simulate 0x59A714559B46c823d87986b5c5B7C630e2f5668d "processOrder(uint256,string,string)" 10 "express" "electronic" --from 0x286AF310eA3303c80eBE9a66F6998B21Bd8c1c29 --rpc %{sepolia_rpc_url} --ethdebug-dir 0x6a85ebf0Eba5307943bDF27D02d198Bc64e9ffEd:TaxCalculator:%{project_root}/test/walnut_0x75964ba0087ff8ae69bd7c17c8c4db66bc0c8e75603f79de1265c61ddfd98f2e_1756985337815_2zvewt/0x6a85ebf0Eba5307943bDF27D02d198Bc64e9ffEd/debug --ethdebug-dir 0xbE734aD6434E16f6bE04706005faED6fD38eb2B2:ShippingManager:%{project_root}/test/walnut_0x75964ba0087ff8ae69bd7c17c8c4db66bc0c8e75603f79de1265c61ddfd98f2e_1756985337815_2zvewt/0xbE734aD6434E16f6bE04706005faED6fD38eb2B2/debug 2>&1 | FileCheck %s

# CHECK: Function Call Trace: None
# CHECK:   TaxCalculator (0x6a85ebf0Eba5307943bDF27D02d198Bc64e9ffEd)
# CHECK:   ShippingManager (0xbE734aD6434E16f6bE04706005faED6fD38eb2B2)
# CHECK: Gas used: 83413
# CHECK: Status: SUCCESS

# Check for the call stack header
# CHECK: Call Stack:
# CHECK:------------------------------------------------------------

# Check that we see the main function call with parameters
# CHECK: #0 Contract::runtime_dispatcher [entry] [non-verified] gas: 61189 @ Contract entry point
# CHECK:  #1 function_0x6f10e157 [0x6f10e157] [external] [non-verified] gas: 61189
# CHECK:     arguments: 0x000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000076578707265737300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a656c656374726f6e696300000000000000000000000000000000000000000000

# Check for internal function calls to other contracts
# CHECK:    #2 CALL → 0xdcDd...Ac0A::log(string) [0x41304fac] [CALL] [non-verified] gas:
# CHECK:       arguments: 0x000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000195374617274696e67206f726465722070726f63657373696e6700000000000000

# CHECK:    #3 CALL → TaxCalculator::calculateTax(uint256,string) [0x55ec8a03] [CALL] → TaxCalculator gas:
# CHECK:       value: 10
# CHECK:       orderType: express
# CHECK:      #4 calculateTax [internal] gas: -144115188075809365 @ TaxCalculator.sol:7
# CHECK:         value: 10
# CHECK:         orderType: express
# CHECK:        #5 getBaseRate [internal] gas: 3433 @ TaxCalculator.sol:18

# CHECK:    #7 CALL → ShippingManager::initiateShipping(address,string) [0x01567ce2] [CALL] → ShippingManager gas:
# CHECK:       customer: 0x286AF310eA3303c80eBE9a66F6998B21Bd8c1c29
# CHECK:       method: electronic
# CHECK:        #8 initiateShipping [internal] gas: -144115188075822559 @ ShippingManager.sol:8
# CHECK:           customer: 0x286AF310eA3303c80eBE9a66F6998B21Bd8c1c29
# CHECK:           method: electronic
# CHECK:          #9 estimateShipping [internal] gas: 2897 @ ShippingManager.sol:17

# Check for payment processing
# CHECK:    #11 CALL → 0xf776...1823::processPayment(address,uint256) [0x0b63fe95] [CALL] [non-verified] gas:
# CHECK:       arguments: 0x000000000000000000000000286af310ea3303c80ebe9a66f6998b21bd8c1c29000000000000000000000000000000000000000000000000000000000000000b

# Check for logging calls
# CHECK:    #12 CALL → 0xdcDd...Ac0A::function_0xe4af64b1 [0xe4af64b1] [CALL] [non-verified] gas:
# CHECK:       arguments: 0x0000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000b000000000000000000000000000000000000000000000000000000000000000e4f7264657220636f6d706c657465000000000000000000000000000000000000

# Check for the footer
# CHECK:------------------------------------------------------------
# CHECK: Use --raw flag to see detailed instruction trace
